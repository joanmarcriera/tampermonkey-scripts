// ==UserScript==
// @name         ServiceNow KB â†’ Obsidian Markdown Export (Clean Content)
// @namespace    https://example.com/snow-kb-obsidian-clean
// @version      1.3
// @description  Export ServiceNow KB article to Obsidian Markdown using clean article body. Supports ESC Portal.
// @match        *://*/kb_view.do*
// @match        *://*/kb_article.do*
// @match        *://*/esc?id=kb_article*
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    function getKbNumber() {
        const el = document.getElementById('articleNumberReadonly');
        if (el && el.textContent.trim()) {
            return el.textContent.trim().split(/\s+/)[0];
        }
        const params = new URLSearchParams(window.location.search);
        const kbNum = params.get('sysparm_article') || params.get('number');
        if (kbNum && kbNum.startsWith('KB')) return kbNum;

        const portalSpan = document.querySelector('.kb-number');
        if (portalSpan && portalSpan.textContent.trim().startsWith('KB')) return portalSpan.textContent.trim();

        return null;
    }

    function getArticleTitle() {
        const el = document.getElementById('articleTitleReadonly') || document.querySelector('.kb-title');
        if (el && el.textContent.trim()) {
            return el.textContent.trim();
        }
        return document.title || 'KB Article';
    }

    function makeSafeFilename(name) {
        return name
            .replace(/[\/\\?%*:|"<>]/g, '_')
            .replace(/\s+/g, ' ')
            .trim()
            .substring(0, 120);
    }

    function getArticleOriginalHtml() {
        const el = document.getElementById('articleOriginal');
        if (el && el.value) return el.value;

        const portalContent = document.querySelector('.kb-article-content') ||
                            document.querySelector('.kb-article-body') ||
                            document.querySelector('article .kb-content') ||
                            document.querySelector('.article-content');
        if (portalContent) return portalContent.innerHTML;

        return '';
    }

    function parseArticleHtml(html) {
        const parser = new DOMParser();
        return parser.parseFromString(html, 'text/html');
    }

    function extractLinksFromDoc(doc) {
        const anchors = Array.from(doc.querySelectorAll('a[href]'));

        const kbLinks = [];
        const incidentLinks = [];
        const googleLinks = [];

        for (const a of anchors) {
            const href = a.getAttribute('href');
            if (!href) continue;

            const label = (a.textContent || '').trim() || href;

            let url;
            try {
                url = new URL(href, window.location.origin);
            } catch (e) {
                continue;
            }

            const hrefStr = url.href;

            if (hrefStr.includes('kb_view.do') || hrefStr.includes('kb_article')) {
                const kb = url.searchParams.get('sysparm_article') || url.searchParams.get('number');
                const sysId = url.searchParams.get('sys_id') || url.searchParams.get('sysparm_sys_id');
                const id = (kb && kb.startsWith('KB')) ? kb : sysId;

                if (id) {
                    kbLinks.push({ kb: id, label });
                    continue;
                }
            }

            if (
                hrefStr.includes('incident.do') ||
                hrefStr.includes('sc_cat_item') ||
                hrefStr.includes('task.do')
            ) {
                incidentLinks.push({ url: hrefStr, label });
                continue;
            }

            if (hrefStr.includes('docs.google.com')) {
                googleLinks.push({ url: hrefStr, label });
                continue;
            }
        }

        return { kbLinks, incidentLinks, googleLinks };
    }

    function extractCleanTextFromDoc(doc) {
        const scripts = doc.querySelectorAll('script, style');
        scripts.forEach(n => n.remove());

        const text = doc.body.innerText || '';
        return text.trim();
    }

    function buildMarkdown(kbNumber, title, links, articleText) {
        const lines = [];

        lines.push('---');
        lines.push(`title: ${title}`);
        if (kbNumber) lines.push(`kb: ${kbNumber}`);
        lines.push('source: ServiceNow');
        lines.push('---');
        lines.push('');

        lines.push(`# ${title}`);
        lines.push('');
        if (kbNumber) {
            lines.push(`**KB:** ${kbNumber}`);
            lines.push('');
        }

        lines.push('## Linked Knowledge Base Articles');
        lines.push('');
        if (links.kbLinks.length === 0) {
            lines.push('_No linked KB articles found._');
        } else {
            const seen = new Set();
            for (const l of links.kbLinks) {
                const key = `${l.kb}|${l.label}`;
                if (seen.has(key)) continue;
                seen.add(key);
                lines.push(`- [[${l.kb}|${l.label}]]`);
            }
        }
        lines.push('');

        lines.push('## Related Incidents / ServiceNow Records');
        lines.push('');
        if (links.incidentLinks.length === 0) {
            lines.push('_No related incident or ServiceNow record links found._');
        } else {
            const seen = new Set();
            for (const l of links.incidentLinks) {
                if (seen.has(l.url)) continue;
                seen.add(l.url);
                lines.push(`- [${l.label}](${l.url})`);
            }
        }
        lines.push('');

        lines.push('## Related Google Documents');
        lines.push('');
        if (links.googleLinks.length === 0) {
            lines.push('_No Google Docs links found._');
        } else {
            const seen = new Set();
            for (const l of links.googleLinks) {
                if (seen.has(l.url)) continue;
                seen.add(l.url);
                lines.push(`- [${l.label}](${l.url})`);
            }
        }
        lines.push('');

        lines.push('## Article Content');
        lines.push('');
        lines.push(articleText || '_No content extracted._');
        lines.push('');

        return lines.join('\n');
    }

    function downloadMarkdown(filename, content) {
        const blob = new Blob([content], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();

        URL.revokeObjectURL(url);
    }

    function addButton() {
        if (document.getElementById('kb-export-obsidian-clean-btn')) return;

        const btn = document.createElement('button');
        btn.id = 'kb-export-obsidian-clean-btn';
        btn.textContent = 'Export to Obsidian (Clean MD)';
        btn.style.position = 'fixed';
        btn.style.bottom = '20px';
        btn.style.right = '20px';
        btn.style.zIndex = 9999;
        btn.style.padding = '8px 12px';
        btn.style.fontSize = '12px';

        btn.onclick = function () {
            const kbNumber = getKbNumber();
            const title = getArticleTitle();

            const rawHtml = getArticleOriginalHtml();
            if (!rawHtml) {
                alert('Could not find article content.');
                return;
            }

            const doc = parseArticleHtml(rawHtml);

            const links = extractLinksFromDoc(doc);
            const articleText = extractCleanTextFromDoc(doc);

            const md = buildMarkdown(kbNumber, title, links, articleText);

            const baseName = makeSafeFilename(kbNumber || title);
            const filename = `${baseName}.md`;

            downloadMarkdown(filename, md);
        };

        document.body.appendChild(btn);
    }

    setTimeout(addButton, 3000);
})();
